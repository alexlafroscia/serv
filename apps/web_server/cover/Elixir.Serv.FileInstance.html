<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>cover/Elixir.Serv.FileInstance.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /Users/alexlafroscia/Code/elixir/serv/apps/file_manager/lib/file_instance.ex by COVER 2017-04-13 at 23:49:46

****************************************************************************

        |  defmodule Serv.FileInstance do
        |    @moduledoc """
        |    Representation of a file instance
        |  
        |    A file instance is a particular version of a file, identified by a hash of the
        |    contents
        |    """
        |  
        |    @enforce_keys [:file, :hash]
     5..|    defstruct [:file, :hash]
        |  
        |    @doc """
        |    Creates a new file instance
        |    """
        |    def create(file, file_content) do
        |      hash = calculate_hash(file_content)
        |      instance = %Serv.FileInstance{
        |        file: file,
        |        hash: hash
        |      }
        |  
        |      directory = file
        |                  |&gt; Serv.File.storage_directory
        |                  |&gt; Path.join(hash)
        |  
        |      case File.mkdir_p(directory) do
        |        :ok -&gt; write_content(instance, file_content)
        |        {:error, reason} -&gt; {:error, reason}
        |      end
        |    end
        |  
        |    @doc """
        |    Gets a file instance by the hash
        |  
        |    ## Examples
        |  
        |      iex&gt; file = %Serv.File{name: "fixture-a", extension: "txt"}
        |      iex&gt; Serv.FileInstance.get(file, "abc")
        |      %Serv.FileInstance{
        |        file: %Serv.File{
        |          name: "fixture-a",
        |          extension: "txt"
        |        },
        |        hash: "abc"
        |      }
        |  
        |    """
        |    def get(file, hash) do
        |      file_directory = Serv.File.storage_directory(file)
        |      instance_dir = [file_directory, hash] |&gt; Path.join
        |  
        |      case File.dir?(instance_dir) do
        |        true -&gt; %Serv.FileInstance{file: file, hash: hash}
        |        false -&gt; nil
        |      end
        |    end
        |  
        |    @doc """
        |    Get the contents of a file instance
        |  
        |    ## Examples
        |  
        |      iex&gt; file = %Serv.File{name: "fixture-a", extension: "txt"}
        |      iex&gt; instance = Serv.FileInstance.get(file, "abc")
        |      iex&gt; Serv.FileInstance.get_content(instance)
        |      "file content\\n"
        |  
        |    """
        |    def get_content(instance) do
        |      file_name = Serv.File.file_name(instance.file)
        |      path = instance
        |             |&gt; location_for
        |             |&gt; Path.join(file_name)
        |  
        |      case File.read(path) do
        |        {:ok, content} -&gt; to_string(content)
        |      end
        |    end
        |  
        |    defp location_for(instance) do
        |      file_store = instance.file |&gt; Serv.File.storage_directory
        |  
        |      file_store
        |      |&gt; Path.join(instance.hash)
        |    end
        |  
        |    defp write_content(instance, content) do
        |      file_name = instance.file |&gt; Serv.File.file_name
        |      full_path = instance
        |                  |&gt; location_for
        |                  |&gt; Path.join(file_name)
        |  
        |      case File.write(full_path, content) do
        |        :ok -&gt; instance
        |        {:error, reason} -&gt; {:error, reason}
        |      end
        |    end
        |  
        |    defp calculate_hash(content) do
        |      hash = :crypto.hash(:md5, content)
        |      Base.encode16(hash)
        |    end
        |  end
</pre>
</body>
</html>
